# Диспетчерская — интерактивный план завода

Веб-приложение для визуализации расположения судов на причалах завода. Отображает интерактивную карту с иконками судов и детальной информацией о каждом судне при наведении.

## Основные возможности

- **Интерактивная карта завода** с масштабируемыми областями причалов
- **Визуализация судов** — иконки с названиями судов на соответствующих причалах
- **Детальная информация** — попап с полными данными о судне при наведении на иконку
- **Визуальная индикация** — специальное отображение судов с швартовкой вторым бортом или кормой
- **Тип расположения** — автоматическое определение и отображение фактического или планового расположения судов
- **Адаптивный дизайн** — автоматическая подгонка областей при изменении размера окна

## Состав репозитория

- `DispetcherskayaMain.html` — основной файл приложения (HTML + встроенные CSS/JS)
- `interactiveAreas.json` — конфигурация интерактивных областей (причалы) с координатами
- `yard_map.jpg` — изображение плана завода
- `ship.png` — иконка судна для отображения на карте
- `dev-journal.md` — хронология изменений и решений
- `README.md` — документация проекта

## Формат входных данных о судах

Приложение ожидает массив объектов JSON с следующими полями:

### Обязательные поля
- `причал` *(string)* — идентификатор причала для сопоставления с интерактивной областью
- `судно` *(string)* — название судна

### Опциональные поля
- `вид_подхода` *(string)* — тип подхода судна (например, "Фактический", "Плановый", "самостоятельно")
- `дата_швартовки` *(string)* — дата/время швартовки в формате `dd.mm.yyyy hh:mm:ss` или ISO
- `дата_выбытия` *(string)* — дата/время выбытия в формате `dd.mm.yyyy hh:mm:ss` или ISO
- `швартовка_вторым_бортом` *(string)* — значение "Да" или "Нет"
- `швартовка_кормой` *(string)* — значение "Да" или "Нет"
- `судно_телефон` *(string)* — номер телефона судна

### Пример данных

```json
[
  {
    "причал": "причал №26",
    "судно": "баржа \"УДА\"",
    "вид_подхода": "Фактический",
    "дата_швартовки": "18.11.2025 16:10:00",
    "дата_выбытия": "19.11.2025 08:30:00",
    "швартовка_вторым_бортом": "Да",
    "швартовка_кормой": "Нет",
    "судно_телефон": "+7 (123) 456-78-90"
  },
  {
    "причал": "причал №27",
    "судно": "Судно №2",
    "вид_подхода": "Плановый",
    "дата_швартовки": "20.11.2025 10:00:00"
  }
]
```

> **Примечание:** В коде встроен парсер `parseManualDataString`, который умеет преобразовывать полуструктурированные строки (без кавычек у ключей) в корректный JSON. При наличии готового JSON рекомендуется передавать его напрямую.

## Формат интерактивных областей

Файл `interactiveAreas.json` содержит массив объектов с обязательными полями:

- `name` *(string)* — отображаемое название области (причала)
- `x`, `y` *(number)* — координаты левого верхнего угла области в пикселях исходной карты
- `width`, `height` *(number)* — ширина и высота области в пикселях
- `matchField` *(string)* — название поля в данных судов для сопоставления (обычно `"причал"`)
- `matchValue` *(string, опционально)* — значение для сопоставления; если не указано, используется `name`

### Пример записи

```json
{
  "name": "причал №26",
  "x": 1103,
  "y": 634,
  "width": 100,
  "height": 100,
  "matchField": "причал",
  "matchValue": "причал №26"
}
```

Координаты должны соответствовать исходному изображению `yard_map.jpg`. При масштабировании окна браузера области автоматически подгоняются под текущий размер карты.

## Особенности интерфейса

### Визуализация судов

- Каждое судно отображается в виде иконки с подписью (названием судна)
- Если на причале несколько судов, они отображаются рядом друг с другом
- При наведении на иконку судна появляется попап с детальной информацией

### Визуальная индикация

Судна с особыми условиями швартовки отображаются специальным образом:
- Если `швартовка_вторым_бортом` или `швартовка_кормой` имеет значение "Да":
  - Иконка становится полупрозрачной (opacity: 0.6)
  - Иконка смещается выше и левее относительно основной позиции

### Тип расположения

В верхней части карты отображается индикатор типа расположения:
- **"Факт"** — если хотя бы одно судно имеет `вид_подхода = "Фактический"`
- **"План"** — если хотя бы одно судно имеет `вид_подхода = "Плановый"` (при отсутствии фактических)

Приоритет отдается фактическому расположению над плановым.

### Попап с информацией

При наведении на иконку судна отображается попап со следующей информацией:
- Название причала (заголовок)
- Название судна
- Вид подхода
- Дата швартовки (форматированная)
- Дата выбытия (форматированная)
- Швартовка вторым бортом (если указано)
- Швартовка кормой (если указано)
- Телефон судна (если указано)

Попап отображается только если есть данные для конкретного судна.

## Настройка `DispetcherskayaMain.html`

В конце файла определены точки конфигурации (строки ~850-851):

```javascript
const externalData = parseManualDataString("scriptData");
const interactiveAreasData = parseInteractiveAreasString("areasData");
const mapImagePath = "C:/Отладка/_Dispetcherskaya/yard_map.jpg";
const iconImagePath = "C:/Отладка/_Dispetcherskaya/ship.png";
```

### Настройка данных

- `externalData` — замените `"scriptData"` на:
  - Строку с данными в формате JSON (будет распарсена)
  - Массив объектов напрямую: `const externalData = [{...}, {...}];`
  - Содержимое JSON-файла, вставленное как строка

- `interactiveAreasData` — подставьте:
  - Содержимое `interactiveAreas.json` как строку
  - Массив объектов напрямую: `const interactiveAreasData = [{...}, {...}];`

### Настройка путей

- `mapImagePath` — путь к изображению карты:
  - Предпочтительно: относительный путь `"yard_map.jpg"`
  - Поддерживаются абсолютные пути Windows (автоматически конвертируются в `file:///`)

- `iconImagePath` — путь к иконке судна:
  - Предпочтительно: относительный путь `"ship.png"`
  - Поддерживаются абсолютные пути Windows

> **Важно:** При использовании абсолютных путей Windows в JavaScript строках необходимо экранировать обратные слеши (`\\` вместо `\`) или использовать прямые слеши (`/`).

## Запуск

### Вариант 1: Через веб-сервер (рекомендуется)

1. Скопируйте все файлы в одну директорию:
   - `DispetcherskayaMain.html`
   - `yard_map.jpg`
   - `ship.png`
   - `interactiveAreas.json` (или вставьте его содержимое в код)

2. Обновите константы в конце `DispetcherskayaMain.html`:
   - Подставьте данные о судах в `externalData`
   - Подставьте данные об областях в `interactiveAreasData`
   - Укажите корректные пути к изображениям

3. Запустите простой веб-сервер из этой папки:
   ```bash
   # Python 3
   python -m http.server 8000
   
   # Или Python 2
   python -m SimpleHTTPServer 8000
   
   # Или Node.js (если установлен http-server)
   npx http-server -p 8000
   ```

4. Откройте в браузере:
   ```
   http://localhost:8000/DispetcherskayaMain.html
   ```

### Вариант 2: Прямое открытие файла

Можно открыть `DispetcherskayaMain.html` напрямую через `file://` протокол, но:
- Абсолютные пути Windows автоматически конвертируются в `file:///` URL
- Могут возникнуть ограничения CORS при загрузке внешних ресурсов
- Запуск через веб-сервер остаётся предпочтительным

## Дизайн

Приложение использует флэт-дизайн в серых тонах:
- Минималистичный интерфейс
- Полупрозрачные элементы управления
- Скругленные углы (4px)
- Тени для глубины
- Компактные размеры шрифтов

## Обработка ошибок

- Области, выходящие за границы изображения, пропускаются с предупреждением в консоли
- При отсутствии данных отображается сообщение "Данные по причалам и судам за указанный период отсутствуют"
- Попап показывается только если есть данные для конкретного судна
- Ошибки парсинга данных выводятся в консоль браузера

## Дополнительные замечания

- Если в данных встречаются кавычки в названиях судов, они автоматически экранируются парсером
- Формат дат поддерживает как `dd.mm.yyyy hh:mm:ss`, так и ISO формат
- Все координаты и размеры автоматически масштабируются при изменении размера окна
- Историю изменений смотрите в `dev-journal.md`

## Технические детали

- Чистый JavaScript (без внешних библиотек)
- Адаптивная верстка с автоматическим масштабированием
- Обработка событий мыши для интерактивности
- Валидация данных и координат областей
- Поддержка различных форматов путей (относительные, абсолютные Windows, file:// URL)
